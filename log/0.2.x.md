# SPXQuery Version 0.2.x Changelog

This file tracks all changes for the 0.2.x release series.

## Version 0.2.2

**Release Date**: 2025-11-13
**Git Tag**: v0.2.2

### Configuration System Migration

**src/spxquery/core/config.py**

- **YAML migration**: All configuration files now use YAML format instead of JSON for better human readability and inline comment support
- Added `to_yaml_file()` and `from_yaml_file()` methods to all config classes
- **Architecture restructure**: `AdvancedConfig` now contains `QueryConfig` as a required field, establishing it as the central configuration "bus"
- **New PhotometryConfig parameters**:
  - `aperture_method`: Choose 'fixed' (constant diameter) or 'fwhm' (adaptive PSF-based sizing). Default changed to 'fwhm'
  - `fwhm_multiplier`: Multiplier for FWHM-based apertures (default: 2.5)
  - `background_method`: Choose 'annulus' (traditional) or 'window' (rectangular region). Default: 'annulus'
  - `window_size`: Window dimensions for window background method (default: 50)
  - `subtract_zodi`: Toggle zodiacal background subtraction (default: True)
  - Expanded `bad_flags` default list to [0, 1, 2, 6, 7, 9, 10, 11, 14, 15, 17, 19]
- **Parameter reorganization**: Moved quality control parameters from `QueryConfig` to `VisualizationConfig`:
  - `sigma_threshold` (default: 5.0)
  - `use_magnitude` (default: False)
  - `show_errorbars` (default: True)

**src/spxquery/utils/params.py**

- Updated `export_default_parameters()` to generate YAML files (.yaml extension)
- Updated `load_advanced_config()` to parse YAML format
- Output messages now reference YAML format

### New Modules

**src/spxquery/processing/background.py** (408 lines)

- Separated background estimation logic from photometry module for better code organization
- Implements two background estimation methods:
  - `estimate_local_background()`: Annular background (refactored from photometry.py)
  - `estimate_window_background()`: Rectangular window background (new)
- Helper functions:
  - `determine_annulus_radii()`: Automatic annulus sizing based on aperture
  - `create_annulus_mask()`: Geometric mask creation for annular regions
- Automatic aperture exclusion in window method (pixels intersecting aperture are excluded)

**src/spxquery/utils/spherex_mef.py** (1,105 lines)

- Comprehensive Multi-Extension FITS handling utilities via `SPHERExMEF` dataclass
- **Unit conversion**: MJy/sr ↔ μJy/arcsec² and other astronomical units
- **PSF extraction**: Access 121-zone oversampled PSF grid with interpolation
- **FWHM estimation**: `get_psf_fwhm_estimate()` for adaptive aperture sizing
- **WCS utilities**: Simplified coordinate transformation wrappers
- **Image cutouts**: Extract subregions with automatic WCS updates
- **Zodi utilities**: Zodiacal background subtraction helpers
- **Context managers**: Suppress astropy warnings during operations

### Photometry Enhancements

**src/spxquery/processing/photometry.py**

- **FWHM-based aperture sizing**: Automatically determine aperture size from PSF full-width-half-maximum
- **Dual background methods**: Support for both annulus and window background estimation via `background_method` parameter
- **Variance repair**: Automatic handling of NaN variance for flagged pixels with valid flux (uses median variance from valid pixels as conservative fallback)
- Code simplification: Delegated background estimation to dedicated `background.py` module (net -83 lines)
- Added `determine_aperture_radius()` function for flexible aperture sizing

**src/spxquery/processing/fits_handler.py**

- Minor cleanup and optimizations

**src/spxquery/processing/lightcurve.py**

- Minor updates for YAML compatibility

### Pipeline and Visualization Updates

**src/spxquery/core/pipeline.py**

- Integrated FWHM-based aperture sizing workflow
- Support for window background method selection
- **YAML state persistence**: Pipeline state files now use .yaml format
- Enhanced error handling and logging for new features
- Better integration with `SPHERExMEF` utilities

**src/spxquery/core/download.py**

- Enhanced download progress tracking
- Improved error messages and retry logic
- Integration with updated configuration structure

**src/spxquery/visualization/plots.py**

- Updated to use quality control parameters from `VisualizationConfig`
- Minor plotting enhancements for new data structures

**src/spxquery/__init__.py**

- Updated exports to include `AdvancedConfig` in public API

### Documentation Updates

- Migrated all documentation references from JSON to YAML
- Updated user guides for new photometry features (FWHM apertures, window backgrounds)
- Added variance repair documentation to quality control guide
- Updated API documentation to include new modules

### Breaking Changes

**None** - This release maintains full backward compatibility:
- All new parameters have sensible defaults
- Configuration files automatically migrate to YAML (YAML parsers can read JSON)
- Existing code using default configurations works unchanged
- API signatures unchanged (new parameters added as optional)

### Migration Notes

For users with custom JSON configuration files:
- JSON files continue to work (YAML parsers accept JSON)
- Recommended: Regenerate as YAML via `export_default_parameters()` for better readability
- Developers importing background functions should update imports to `from spxquery.processing.background import ...`

## Version 0.2.1

**Release Date**: 2025-11-05
**Git Tag**: v0.2.1

### Photometry Background Mask

- **src/spxquery/processing/fits_handler.py**: `create_background_mask` now retains SOURCE-flagged pixels when building the zodiacal-light background mask so local annuli keep nearby source pixels available for brightness scaling, improving robustness around bright targets.

## Version 0.2.0

**Release Date**: 2025-10-27
**Git Tag**: v0.2.0

### New Features

**src/spxquery/core/config.py**

- Added advanced parameter configuration system with three new dataclasses:
  - `PhotometryConfig`: Configurable photometry parameters (aperture, background annulus, sigma clipping, zodiacal scaling)
  - `VisualizationConfig`: Configurable visualization parameters (colormaps, marker sizes, figure settings, DPI)
  - `DownloadConfig`: Configurable download parameters (chunk size, timeouts, retries, user agent)
  - `AdvancedConfig`: Container class holding all three config types
- Reorganized class definition order to place config classes before QueryConfig to fix dependency issues
- Added comprehensive validation in `__post_init__` methods for all config classes
- Added `to_dict()`, `from_dict()`, `to_json_file()`, and `from_json_file()` serialization methods
- Dynamic version in `user_agent`: Changed from hardcoded "SPXQuery/0.1.0" to use package `__version__` automatically

**src/spxquery/utils/params.py**

- New utility module for parameter template management
- `export_default_parameters()`: Export default configuration template to JSON file
- `load_advanced_config()`: Load configuration from JSON file with validation

**src/spxquery/visualization/plots.py**

- Added TYPE_CHECKING import pattern for VisualizationConfig to avoid circular imports
- Updated function signatures to accept VisualizationConfig for customizable plotting

### Priority System

The package now supports a three-tier parameter priority system:

1. Explicit function parameters (highest priority)
2. JSON configuration file parameters
3. Built-in defaults (lowest priority)

Users can export a template with `export_default_parameters()`, customize it, and load it via `QueryConfig(advanced_params_file=...)` or `run_pipeline(advanced_params_file=...)`.

### Technical Improvements

- All configuration classes use dataclasses with field validation
- JSON serialization handles special types (tuples converted to lists for JSON compatibility)
- User agent now dynamically reflects package version for better API tracking
- Comprehensive test coverage added for all configuration functionality
