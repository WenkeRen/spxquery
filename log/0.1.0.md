# Version 0.1.0

**Release Date**: Initial Release

## Core Features

### core/config.py
- Configuration dataclasses: `Source`, `QueryConfig`, `ObservationInfo`, `QueryResults`, `PhotometryResult`, `DownloadResult`, `PipelineState`
- Input validation for coordinates, bands, aperture parameters, and cutout specifications
- Smart state loading with priority: user-provided > saved state > defaults
- `QueryConfig.from_saved_state()` method for resumable pipeline support
- **ObservationInfo simplified**: Removed per-observation `ra`, `dec`, and `file_size_mb` fields (use source coordinates and actual download sizes instead)
- **Field renamed**: `access_url` → `download_url` for clarity (no longer datalink URLs)

### core/query.py
- TAP query interface to IRSA SPHEREx archive using `spherex.artifact` + `spherex.plane` JOIN
- **Direct download URL construction**: URLs built in SQL query, eliminating separate datalink resolution step
- **obs_id extraction**: Regex pattern extracts observation ID from `obs_publisher_did` field
- Query summary reporting (observation counts, time span)
- Support for coordinate-based queries with band filtering
- **Removed**: Datalink URL resolution, URL caching (`download_urls.json`), retry logic for URL resolution (~300 lines removed)

### core/download.py
- Parallel FITS file downloads using ThreadPoolExecutor
- Progress tracking with tqdm
- Automatic directory organization by band (data/D1/, data/D2/, etc.)
- **Cutout parameters appended on-the-fly during download** (not pre-cached)
- File size verification and error handling

### core/pipeline.py
- `SPXQueryPipeline` class with resumable execution
- Four-stage pipeline: query → download → processing → visualization
- Stage dependency checking for manual execution
- State persistence to `{source_name}.json` after each stage
- Methods: `run_full_pipeline()`, `run_query()`, `run_download()`, `run_processing()`, `run_visualization()`
- **Simplified download stage**: Cutout parameters appended to base URLs during download (no separate URL resolution or caching)

## Processing Features

### processing/fits_handler.py
- Multi-Extension FITS (MEF) file parsing
- Spectral WCS handling with SIP distortion fix (`spectral_wcs.sip = None`)
- World coordinate transformations (RA/Dec → pixel coordinates)
- Wavelength/bandwidth extraction from WCS-WAVE lookup table

### processing/photometry.py
- Aperture photometry using photutils
- Zodiacal background subtraction (ZODI extension)
- Pixel quality flag aggregation
- Parallel processing using ProcessPoolExecutor
- Per-observation photometry results with uncertainty propagation

### processing/lightcurve.py
- Time-series data aggregation from photometry results
- CSV export with columns: MJD, wavelength, flux, flux_err, band, flag, pixel coordinates
- AB magnitude calculation (optional)
- Summary statistics (observation counts, wavelength ranges, time coverage)

### processing/magnitudes.py
- Flux-to-AB magnitude conversion: `mag_ab = -2.5 * log10(flux_mjy_sr / 3631)`
- Uncertainty propagation for magnitude errors
- Upper limit handling for low SNR measurements

## Visualization Features

### visualization/plots.py
- Combined spectral and temporal plots
- Quality control filtering: `sigma_threshold` (SNR), `bad_flags` (pixel flags)
- Good measurements (filled circles) vs rejected (gray crosses with reduced alpha)
- Support for flux or AB magnitude y-axis
- Optional error bars
- LaTeX-formatted axis labels respecting user's matplotlibrc

## Utilities

### utils/helpers.py
- Logging setup with configurable levels
- JSON I/O for state persistence
- Cutout parameter validation (size and center)
- File discovery utilities

## Key Capabilities

- **Image Cutouts**: Supports IRSA cutout service (e.g., "200px", "3arcmin") appended during download to reduce file sizes from ~70 MB to ~0.7 MB
- **Quality Control**: Configurable SNR threshold and bad pixel flags (applied to visualization only)
- **Resumability**: Pipeline saves state after each stage; can restart from any completed stage
- **Parallel Processing**: Multi-threaded downloads (default: 4 workers), multi-process photometry (default: 10 workers)
- **Simplified Architecture**: Direct URL construction in TAP query eliminates datalink resolution step and URL caching

## Architectural Design

### Query-to-Download Flow

**Simplified approach (no intermediate URL resolution):**

1. **TAP Query** (`core/query.py`):
   - Queries `spherex.artifact` + `spherex.plane` tables with JOIN
   - Constructs base download URLs directly: `'https://irsa.ipac.caltech.edu/' || a.uri`
   - Extracts `obs_id` from `obs_publisher_did` using regex pattern
   - Returns `ObservationInfo` objects with `download_url` field

2. **Download Stage** (`core/pipeline.py`):
   - Appends cutout parameters to base URLs on-the-fly using `format_cutout_url_params()`
   - Passes final URLs to parallel downloader
   - Updates total file size in state after download completes

3. **No Caching**: URLs are ephemeral - constructed when needed, not stored

### Benefits Over Previous Design

- **Fewer HTTP requests**: No separate datalink lookups for each observation
- **Simpler code**: ~300 lines removed (datalink resolution, caching, retry logic)
- **Faster execution**: Single TAP query instead of query + N datalink resolutions
- **Less storage**: No `download_urls.json` cache file or retry counters
- **More maintainable**: One-stage URL construction instead of two-stage process
